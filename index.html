<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM Schedule Manager</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}.auth-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}.auth-box{background:white;padding:40px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);width:100%;max-width:450px}.auth-box h2{text-align:center;color:#003366;margin-bottom:10px}.auth-box p{text-align:center;color:#666;margin-bottom:30px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;color:#333;font-weight:600}.form-group input{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box}.form-group input:focus{outline:none;border-color:#003366;box-shadow:0 0 0 3px rgba(0,51,102,0.1)}.auth-btn{width:100%;padding:12px;background-color:#003366;color:white;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color 0.2s;margin-bottom:10px}.auth-btn:hover{background-color:#0055aa}.auth-btn:disabled{background-color:#ccc;cursor:not-allowed}.message{font-size:14px;margin-top:10px;text-align:center;padding:10px;border-radius:6px;display:none}.error-message{color:#dc3545;background-color:#f8d7da;border:1px solid #f5c6cb}.success-message{color:#155724;background-color:#d4edda;border:1px solid #c3e6cb}.toggle-link{text-align:center;margin-top:15px;color:#003366;cursor:pointer;text-decoration:underline}.toggle-link:hover{color:#0055aa}.logout-bar{background:#003366;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.logout-bar span{font-weight:600}.logout-btn{background:rgba(255,255,255,0.2);color:white;border:1px solid white;padding:8px 20px;border-radius:6px;cursor:pointer;font-weight:600;transition:background-color 0.2s}.logout-btn:hover{background:rgba(255,255,255,0.3)}.pm-container{max-width:95%;margin:20px auto;background:#ffffff;border:1px solid #ddd;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.pm-container h2{text-align:center;color:#003366;margin-bottom:20px;font-size:24px}.action-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}.action-bar h3{margin:0;color:#003366;font-size:18px}.btn-group{display:flex;gap:10px}.export-btn{background-color:#28a745;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;transition:background-color 0.2s}.export-btn:hover{background-color:#218838}.toggle-completed-btn{background-color:#6c757d;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;transition:background-color 0.2s}.toggle-completed-btn:hover{background-color:#5a6268}table{width:100%;border-collapse:collapse;margin-bottom:20px;background:white}th,td{border:1px solid #e0e0e0;padding:12px;text-align:center}th{background-color:#003366;color:white;cursor:pointer;user-select:none;font-weight:600}th:hover{background-color:#0055aa}th.sortable::after{content:" â‡…";font-size:0.8em;opacity:0.5}th.sort-asc::after{content:" â–²";opacity:1}th.sort-desc::after{content:" â–¼";opacity:1}.input-row{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:20px}input,select,button{padding:10px;border-radius:6px;border:1px solid #ccc;font-size:14px}input:focus,select:focus{outline:none;border-color:#003366;box-shadow:0 0 0 2px rgba(0,51,102,0.1)}button{background-color:#003366;color:white;cursor:pointer;font-weight:600;border:none;transition:background-color 0.2s}button:hover{background-color:#0055aa}button:disabled{background-color:#ccc;cursor:not-allowed}tr[data-status="In Queue"]{background-color:#fffef0}tr[data-status="In Progress"]{background-color:#f0f8ff}tr[data-status="Completed"]{background-color:#f0fff4}tr[data-status="Delayed"]{background-color:#fff5f5}#calendar{max-width:95%;margin:30px auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}.calendar-controls{max-width:95%;margin:20px auto;text-align:center}.calendar-controls button{margin:0 5px;padding:10px 20px;font-size:14px;border-radius:6px}.calendar-controls button.active{background-color:#0055aa;font-weight:bold}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}.modal-content{background-color:#fefefe;margin:10% auto;padding:30px;border:none;width:80%;max-width:450px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.2)}.close{color:#999;float:right;font-size:28px;font-weight:bold;cursor:pointer;line-height:20px}.close:hover{color:#333}.hidden{display:none}.info-badge{display:inline-block;background-color:#e3f2fd;color:#1976d2;padding:5px 12px;border-radius:12px;font-size:13px;margin-left:10px}
</style>
</head>
<body>
<div id="authScreen" class="auth-container">
<div class="auth-box">
<div id="loginForm">
<h2>ðŸ”’ PM Schedule Manager</h2>
<p>Please log in to continue</p>
<div class="form-group">
<label for="loginEmail">Email Address</label>
<input type="email" id="loginEmail" placeholder="Enter your email" autocomplete="email" required />
</div>
<div class="form-group">
<label for="loginPassword">Password</label>
<input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password" required />
</div>
<button class="auth-btn" id="loginBtn">Log In</button>
<div id="loginMessage" class="message error-message"></div>
<div class="toggle-link" id="showRegisterLink">Don't have an account? Register here</div>
</div>
<div id="registerForm" class="hidden">
<h2>ðŸ”’ Create Account</h2>
<p>Register to access PM Schedule Manager</p>
<div class="form-group">
<label for="registerEmail">Email Address</label>
<input type="email" id="registerEmail" placeholder="Enter your email" autocomplete="email" required />
</div>
<div class="form-group">
<label for="registerPassword">Password</label>
<input type="password" id="registerPassword" placeholder="Create password (min 6 characters)" autocomplete="new-password" required />
</div>
<div class="form-group">
<label for="registerConfirmPassword">Confirm Password</label>
<input type="password" id="registerConfirmPassword" placeholder="Confirm password" autocomplete="new-password" required />
</div>
<button class="auth-btn" id="registerBtn">Create Account</button>
<div id="registerMessage" class="message"></div>
<div class="toggle-link" id="showLoginLink">Already have an account? Log in here</div>
</div>
</div>
</div>
<div id="mainApp" class="hidden">
<div class="logout-bar">
<span>Welcome, <span id="loggedInUser"></span></span>
<button class="logout-btn" id="logoutBtn">Log Out</button>
</div>
<div class="pm-container">
<h2>PM Schedule Manager</h2>
<div class="action-bar">
<div><h3>Active PM Schedule <span class="info-badge" id="activeBadge">0 active</span></h3></div>
<div class="btn-group">
<button class="toggle-completed-btn" id="toggleBtn">Show Completed</button>
<button class="export-btn" id="exportBtn">ðŸ“Š Export All Data</button>
</div>
</div>
<table id="pmTable">
<thead>
<tr>
<th>Truck #</th>
<th class="sortable" id="sortDateHeader">Next PM Date/Time</th>
<th>PM Type</th>
<th>% Due</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="pmBody"></tbody>
</table>
<div class="input-row">
<input type="text" id="truckNum" placeholder="Truck #" style="width:100px;" />
<input type="date" id="pmDate" style="width:150px;" />
<input type="time" id="pmTime" value="08:00" style="width:120px;" />
<select id="pmType" style="width:140px;">
<option value="">PM Type</option>
<option value="PMA">PMA (2 hrs)</option>
<option value="PMB">PMB (4 hrs)</option>
<option value="PMC">PMC (6 hrs)</option>
</select>
<input type="number" id="percentDue" placeholder="% Due" min="0" max="100" style="width:100px;" />
<select id="status" style="width:130px;">
<option value="In Queue">In Queue</option>
<option value="In Progress">In Progress</option>
<option value="Completed">Completed</option>
<option value="Delayed">Delayed</option>
</select>
<button type="button" id="addTruckBtn">Add Truck</button>
</div>
<div class="calendar-controls">
<button id="viewDay" data-view="timeGridDay">Day</button>
<button id="viewWeek" data-view="timeGridWeek">Week</button>
<button id="view2Week" data-view="timeGrid2Week">2 Weeks</button>
<button id="viewMonth" data-view="dayGridMonth" class="active">Month</button>
</div>
<div id="calendar"></div>
</div>
</div>
<div id="detailsModal" class="modal">
<div class="modal-content">
<span class="close" id="closeModalBtn">&times;</span>
<h3 style="color:#003366;margin-top:0;">PM Details</h3>
<p id="modalContent" style="line-height:1.8;"></p>
</div>
</div>
<script>
(function(){'use strict';const U='https://aogzfrrkntulftihdrdf.supabase.co',K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZ3pmcnJrbnR1bGZ0aWhkcmRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NTc0NjYsImV4cCI6MjA3NzAzMzQ2Nn0.qp6NWw8LuFsB6E2LWiJXkxduWxP3uw8yuR32dBHXMbA';let s,u=null,pm=[],all=[],cal,so="asc",cv="dayGridMonth",sc=false;try{s=window.supabase.createClient(U,K)}catch(e){console.error('Failed to init Supabase:',e)}function msg(i,m,t){const e=document.getElementById(i);e.textContent=m;e.className=`message ${t}-message`;e.style.display='block';setTimeout(()=>e.style.display='none',5000)}function showL(){document.getElementById('loginForm').classList.remove('hidden');document.getElementById('registerForm').classList.add('hidden')}function showR(){document.getElementById('registerForm').classList.remove('hidden');document.getElementById('loginForm').classList.add('hidden')}async function reg(){if(!s){msg('registerMessage','System not configured','error');return}const e=document.getElementById('registerEmail').value.trim().toLowerCase(),p=document.getElementById('registerPassword').value,c=document.getElementById('registerConfirmPassword').value,b=document.getElementById('registerBtn');if(!e||!p||!c){msg('registerMessage','Please fill all fields','error');return}if(p.length<6){msg('registerMessage','Password must be 6+ chars','error');return}if(p!==c){msg('registerMessage','Passwords do not match','error');return}b.disabled=true;b.textContent='Creating...';const{data,error}=await s.auth.signUp({email:e,password:p});b.disabled=false;b.textContent='Create Account';if(error){msg('registerMessage',error.message,'error');return}msg('registerMessage','Account created! You can now log in.','success');setTimeout(()=>{document.getElementById('registerEmail').value='';document.getElementById('registerPassword').value='';document.getElementById('registerConfirmPassword').value='';showL()},2000)}async function login(){if(!s){msg('loginMessage','System not configured','error');return}const e=document.getElementById('loginEmail').value.trim().toLowerCase(),p=document.getElementById('loginPassword').value,b=document.getElementById('loginBtn');if(!e||!p){msg('loginMessage','Enter email and password','error');return}b.disabled=true;b.textContent='Logging In...';const{data,error}=await s.auth.signInWithPassword({email:e,password:p});b.disabled=false;b.textContent='Log In';if(error){msg('loginMessage','Invalid email or password','error');return}u=data.user;document.getElementById('loggedInUser').textContent=e;document.getElementById('authScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');await init()}async function logout(){if(s)await s.auth.signOut();u=null;document.getElementById('authScreen').classList.remove('hidden');document.getElementById('mainApp').classList.add('hidden');document.getElementById('loginEmail').value='';document.getElementById('loginPassword').value='';showL()}async function checkSess(){if(!s)return false;const{data:{session}}=await s.auth.getSession();if(session){u=session.user;document.getElementById('loggedInUser').textContent=session.user.email;document.getElementById('authScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');await init();return true}return false}async function load(){if(!s)return[];const{data,error}=await s.from('pm_schedules').select('*').order('pm_date_time',{ascending:true});if(error){console.error('Error loading:',error);return[]}return data.map(r=>({id:r.id,truck:r.truck_number,dateTime:r.pm_date_time,date:r.pm_date_time.split(' ')[0],type:r.pm_type,percent:r.percent_due,status:r.status}))}async function add(){if(!s){alert('System not configured');return}const t=document.getElementById('truckNum').value.trim(),d=document.getElementById('pmDate').value,ti=document.getElementById('pmTime').value,ty=document.getElementById('pmType').value,pe=parseInt(document.getElementById('percentDue').value)||0,st=document.getElementById('status').value;if(!t||!d||!ty){alert('Fill Truck #, Date, and PM Type');return}const dt=`${d} ${ti}`;const{error}=await s.from('pm_schedules').insert([{truck_number:t,pm_date_time:dt,pm_type:ty,percent_due:pe,status:st}]).select();if(error){console.error('Error adding:',error);alert('Failed to add');return}document.getElementById('truckNum').value='';document.getElementById('pmDate').value='';document.getElementById('pmTime').value='08:00';document.getElementById('pmType').value='';document.getElementById('percentDue').value='';await ref()}async function updP(id,p){if(!s)return;const{error}=await s.from('pm_schedules').update({percent_due:parseInt(p)}).eq('id',id);if(!error)await ref();else console.error('Error:',error)}async function updS(id,st){if(!s)return;const{error}=await s.from('pm_schedules').update({status:st}).eq('id',id);if(!error)await ref();else console.error('Error:',error)}async function rem(id){if(!s)return;if(!confirm('Remove this PM?'))return;const{error}=await s.from('pm_schedules').delete().eq('id',id);if(!error)await ref();else console.error('Error:',error)}async function ref(){all=await load();filt();rend();badge()}function filt(){pm=sc?all:all.filter(i=>i.status!=='Completed')}function tog(){sc=!sc;document.getElementById('toggleBtn').textContent=sc?'Hide Completed':'Show Completed';filt();rend();badge()}function badge(){const a=all.filter(i=>i.status!=='Completed').length,c=all.filter(i=>i.status==='Completed').length;document.getElementById('activeBadge').textContent=`${a} active${c>0?', '+c+' completed':''}`}async function exp(){if(!s){alert('System not configured');return}const d=await load();if(!d.length){alert('No data');return}const h=['Truck #','Date/Time','PM Type','% Due','Status'],csv=[h.join(','),...d.map(r=>[r.truck,`"${r.dateTime}"`,r.type,r.percent,r.status].join(','))].join('\n'),b=new Blob([csv],{type:'text/csv;charset=utf-8;'}),l=document.createElement('a'),ur=URL.createObjectURL(b),ts=new Date().toISOString().split('T')[0];l.setAttribute('href',ur);l.setAttribute('download',`PM_Export_${ts}.csv`);l.style.visibility='hidden';document.body.appendChild(l);l.click();document.body.removeChild(l)}function dur(t){switch(t.toUpperCase()){case"PMA":return 2;case"PMB":return 4;case"PMC":return 6;default:return 0}}function col(st){switch(st){case"In Queue":return"#FFD700";case"In Progress":return"#1E90FF";case"Completed":return"#32CD32";case"Delayed":return"#DC143C";default:return"#808080"}}function fmt(dt){if(!dt)return"";const p=dt.split(" ");return p.length===2?`${p[0]} ${p[1]}`:dt}function sort(){pm.sort((a,b)=>{const dA=new Date(a.dateTime||a.date),dB=new Date(b.dateTime||b.date);return so==="asc"?dA-dB:dB-dA});so=so==="asc"?"desc":"asc";const h=document.getElementById('sortDateHeader');h.classList.remove("sort-asc","sort-desc");h.classList.add(so==="asc"?"sort-desc":"sort-asc");rend()}function rend(){const b=document.getElementById("pmBody");b.innerHTML="";pm.forEach(r=>{const tr=document.createElement("tr");tr.setAttribute("data-status",r.status);tr.innerHTML=`<td>${r.truck}</td><td>${fmt(r.dateTime||r.date)}</td><td>${r.type}</td><td><input type="number" value="${r.percent}" min="0" max="100" style="width:60px;padding:4px;text-align:center;" data-id="${r.id}" />%</td><td><select data-id="${r.id}"><option value="In Queue" ${r.status==="In Queue"?"selected":""}>In Queue</option><option value="In Progress" ${r.status==="In Progress"?"selected":""}>In Progress</option><option value="Completed" ${r.status==="Completed"?"selected":""}>Completed</option><option value="Delayed" ${r.status==="Delayed"?"selected":""}>Delayed</option></select></td><td><button data-id="${r.id}" class="rb">Remove</button></td>`;b.appendChild(tr)});document.querySelectorAll('#pmBody input[type="number"]').forEach(i=>i.addEventListener('change',function(){updP(this.dataset.id,this.value)}));document.querySelectorAll('#pmBody select').forEach(sel=>sel.addEventListener('change',function(){updS(this.dataset.id,this.value)}));document.querySelectorAll('.rb').forEach(btn=>btn.addEventListener('click',function(){rem(this.dataset.id)}));rendC()}function rendC(){const ev=all.map(i=>{const d=dur(i.type);let ti=`${i.truck} - ${i.type}`;if(i.status==="In Progress"&&d>0)ti+=` (${d}h)`;let end=null;if(i.dateTime&&d>0){const st=new Date(i.dateTime);end=new Date(st.getTime()+d*60*60*1000)}return{id:i.id,title:ti,start:i.dateTime||i.date,end:end,backgroundColor:col(i.status),borderColor:col(i.status),extendedProps:{percent:i.percent,status:i.status,duration:d,truck:i.truck,type:i.type,dateTime:i.dateTime}}});const ce=document.getElementById("calendar");if(!cal){cal=new FullCalendar.Calendar(ce,{initialView:cv,headerToolbar:{left:'prev,next today',center:'title',right:''},height:"auto",slotMinTime:"06:00:00",slotMaxTime:"20:00:00",slotDuration:"00:30:00",allDaySlot:true,nowIndicator:true,eventOverlap:true,views:{timeGrid2Week:{type:'timeGrid',duration:{weeks:2},buttonText:'2 weeks',slotLabelInterval:'01:00'}},events:ev,eventClick:function(info){showDet(info)}});cal.render()}else{cal.removeAllEvents();cal.addEventSource(ev)}}function chView(v,e){cv=v;if(cal)cal.changeView(v);document.querySelectorAll('.calendar-controls button').forEach(b=>b.classList.remove('active'));if(e&&e.target)e.target.classList.add('active')}function showDet(info){const d=info.event.extendedProps,mo=document.getElementById("detailsModal"),mc=document.getElementById("modalContent"),dt=d.duration>0?`${d.duration} hours`:'N/A';mc.innerHTML=`<strong>Truck:</strong> ${d.truck}<br><strong>Date/Time:</strong> ${d.dateTime||info.event.startStr}<br><strong>Type:</strong> ${d.type}<br><strong>Duration:</strong> ${dt}<br><strong>% Due:</strong> ${d.percent}%<br><strong>Status:</strong> ${d.status}`;mo.style.display='block'}function closeMo(){document.getElementById("detailsModal").style.display='none'}window.onclick=function(e){const mo=document.getElementById("detailsModal");if(e.target===mo)mo.style.display='none'};async function init(){await ref()}document.addEventListener('DOMContentLoaded',async function(){const se=await checkSess();if(!se)document.getElementById('authScreen').classList.remove('hidden');document.getElementById('loginBtn').addEventListener('click',login);document.getElementById('registerBtn').addEventListener('click',reg);document.getElementById('showRegisterLink').addEventListener('click',showR);document.getElementById('showLoginLink').addEventListener('click',showL);document.getElementById('logoutBtn').addEventListener('click',logout);document.getElementById('toggleBtn').addEventListener('click',tog);document.getElementById('exportBtn').addEventListener('click',exp);document.getElementById('addTruckBtn').addEventListener('click',add);document.getElementById('sortDateHeader').addEventListener('click',sort);document.getElementById('closeModalBtn').addEventListener('click',closeMo);document.querySelectorAll('.calendar-controls button').forEach(b=>b.addEventListener('click',function(e){chView(this.dataset.view,e)}));document.getElementById('loginEmail').addEventListener('keypress',e=>{if(e.key==='Enter')login()});document.getElementById('loginPassword').addEventListener('keypress',e=>{if(e.key==='Enter')login()});document.getElementById('registerConfirmPassword').addEventListener('keypress',e=>{if(e.key==='Enter')reg()})})})();
</script>
</body>
</html>
